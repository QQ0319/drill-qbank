<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>åˆ·é¡Œè¤‡ç¿’é¡Œåº« v1.2ï¼ˆå¤šäººï¼‹æ¯äººç¨ç«‹éŒ¯é¡Œ/é‡è¦/ç‰¹æ®Šï¼‹SRSï¼‹åœ–ç‰‡ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg:#f6f8ff; --card:#ffffff; --ink:#1f2937; --mut:#6b7280;
      --pri:#6366f1; --pri2:#8b5cf6; --ok:#16a34a; --warn:#b45309; --err:#dc2626; --bor:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:radial-gradient(1200px 600px at 10% -10%,#eef2ff 0,#f6f8ff 60%,#fefefe 100%);
      color:var(--ink);
      font:16px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif
    }
    .wrap{max-width:1180px;margin:0 auto;padding:20px}
    header h1{margin:0 0 6px;font-size:24px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    header h1 .badge{font-size:12px;padding:2px 8px;border-radius:999px;background:#eef2ff;border:1px solid #e0e7ff}
    header p{margin:0;color:var(--mut);font-size:14px}
    .namebox{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px}
    .namebox input,.namebox select{padding:8px 10px;border:1px solid var(--bor);border-radius:12px;background:#fff}
    nav{display:flex;gap:8px;margin:14px 0 10px;align-items:center;flex-wrap:wrap}
    nav button{
      border:1px solid var(--bor);background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer;
      transition:transform .05s ease, box-shadow .2s ease
    }
    nav button.active{
      background:linear-gradient(90deg,var(--pri),var(--pri2));color:#fff;border-color:transparent;
      box-shadow:0 6px 16px rgba(99,102,241,.25)
    }
    nav button:active{ transform: translateY(1px) }
    .panel{background:#fff;border:1px solid var(--bor);border-radius:16px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:1020px){.grid{grid-template-columns:2fr 3fr}}
    label{font-size:13px;color:var(--mut)}
    input[type="text"], input[type="number"], textarea, select{width:100%;padding:10px 12px;border:1px solid var(--bor);border-radius:12px;background:#fff}
    textarea{min-height:120px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .btns{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:700;background:linear-gradient(90deg,var(--pri),var(--pri2));color:#fff}
    .btn.secondary{background:#11182710;color:#111827;border:1px solid var(--bor)}
    .btn.warn{background:#fef3c7;color:#8a4b00;border:1px solid #f3e2a3}
    .btn.success{background:#22c55e;color:#fff}
    .pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:2px 8px;border-radius:999px;background:#11182708;border:1px solid var(--bor);margin-right:6px}
    .ok{color:var(--ok)}.warnText{color:var(--warn)}.err{color:var(--err)}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--bor);padding:8px;vertical-align:top}
    th{background:#f8fafc}
    .card{border:1px solid var(--bor);border-radius:16px;padding:14px;background:#fff}
    .card h3{margin:0 0 8px;font-size:18px}
    .q,.a{white-space:pre-wrap}
    .a{display:none;border-top:1px dashed var(--bor);padding-top:8px}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111827;color:#fff;padding:8px 12px;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.2);font-size:14px;z-index:9999}
    .mut{color:var(--mut)}
    .thumb{display:block;max-width:200px;max-height:140px;border:1px solid var(--bor);border-radius:8px;margin-top:6px}
    .imgcell img{max-width:120px;max-height:90px;border:1px solid var(--bor);border-radius:8px}
    .tag{display:inline-block;padding:2px 6px;border-radius:999px;background:#f3f4f6;border:1px solid var(--bor);font-size:12px;margin-right:4px}
    .progress{height:10px;background:#eef2ff;border-radius:999px;overflow:hidden}
    .progress>div{height:100%;background:linear-gradient(90deg,var(--pri),var(--pri2))}
    @media print{ nav, .namebox, .toolbar, .btn, .btns, .no-print{display:none} .panel{box-shadow:none;border:0} }
    .confetti{position:fixed;inset:0;pointer-events:none}
  </style>
</head>
<body>
  <canvas id="confetti" class="confetti"></canvas>
  <div class="wrap">
    <header>
      <h1>
        <span id="bank-title">åˆ·é¡Œè¤‡ç¿’é¡Œåº«</span>
        <span class="badge">v1.2ï½œå¤šäººï¼†æ¯äººç¨ç«‹éŒ¯é¡Œ/é‡è¦/ç‰¹æ®Šï½œé›¢ç·šå–®æª”</span>
      </h1>
      <div class="namebox">
        <label>é¡Œåº«åç¨±</label><input id="bank-name" type="text" placeholder="ä¾‹ï¼šå®¶åº­åˆ·é¡Œé¡Œåº«" style="width:240px">
        <label>ç›®å‰ä½¿ç”¨è€…</label>
        <select id="user-select" style="width:180px"></select>
        <button class="btn secondary" id="btn-user-add">æ–°å¢ä½¿ç”¨è€…</button>
        <button class="btn secondary" id="btn-user-edit">ç·¨è¼¯ä½¿ç”¨è€…</button>
        <button class="btn warn" id="btn-user-del">åˆªé™¤ä½¿ç”¨è€…</button>
        <span class="pill" id="cur-user-pill">â€”</span>
      </div>
      <p class="mut">é¡Œç›®ï¼ˆå…§å®¹ï¼‰å…±ç”¨ï¼›æ¯ä½ä½¿ç”¨è€…å„è‡ªæœ‰ã€ŒéŒ¯é¡Œ/é‡è¦/ç‰¹æ®Šã€æ¨™è¨˜ã€SRS é–“éš”èˆ‡ä½œç­”çµ±è¨ˆã€‚æ”¯æ´ JSON åŒ¯å…¥åŒ¯å‡ºèˆ‡è‡ªå‹•å‚™ä»½ã€‚</p>
    </header>

    <nav>
      <button class="tabBtn active" data-tab="add">æ–°å¢é¡Œç›®</button>
      <button class="tabBtn" data-tab="list">é¡Œåº«åˆ—è¡¨</button>
      <button class="tabBtn" data-tab="practice">åˆ·é¡Œæ¨¡å¼</button>
      <button class="tabBtn" data-tab="stats">çµ±è¨ˆ</button>
      <span class="pill" id="stat">â€”</span>
    </nav>

    <!-- æ–°å¢é¡Œç›® -->
    <section id="tab-add" class="panel">
      <div class="grid">
        <div>
          <div class="row3">
            <div>
              <label>é¡Œç›®IDï¼ˆå¯ç•™ç™½è‡ªå‹•ç”¢ç”Ÿï¼‰</label>
              <input id="f-id" type="text" placeholder="ä¾‹å¦‚ BK-MA-001" />
            </div>
            <div>
              <label>ç§‘ç›®</label>
              <select id="f-subject">
                <option value="åœ‹æ–‡">åœ‹æ–‡</option>
                <option value="è‹±æ–‡">è‹±æ–‡</option>
                <option value="æ•¸å­¸" selected>æ•¸å­¸</option>
                <option value="è‡ªç„¶">è‡ªç„¶</option>
                <option value="ç¤¾æœƒ">ç¤¾æœƒ</option>
              </select>
            </div>
            <div>
              <label>é©ç”¨å¹´ç´šï¼ˆ1ï½9ï¼‰</label>
              <input id="f-grade" type="number" min="1" max="9" value="1"/>
            </div>
          </div>
          <div>
            <label>çŸ­æ¨™é¡Œï¼ˆå¿…å¡«ï¼Œå»ºè­°20å­—å…§ï¼‰</label>
            <input id="f-title" type="text" placeholder="ä¾‹å¦‚ï¼šåˆ†æ•¸é€šåˆ†å°æŠ€å·§" />
          </div>
          <div>
            <label>é¡Œç›®ï¼ˆå¿…å¡«ï¼‰</label>
            <textarea id="f-q" placeholder="è¼¸å…¥é¡Œç›®æ–‡å­—æˆ–æ•˜è¿°"></textarea>
          </div>
          <div class="row">
            <div>
              <label>åƒè€ƒè§£ç­”ï¼ˆå»ºè­°å¡«ï¼‰</label>
              <textarea id="f-a" placeholder="è¼¸å…¥è§£ç­”æˆ–é‡é»"></textarea>
            </div>
            <div>
              <label>é¡Œç›®åœ–ç‰‡ï¼ˆå¯ä¸Šå‚³æ‹é¡Œç…§ç‰‡ï¼‰</label>
              <input id="f-img" type="file" accept="image/*">
              <img id="img-preview" class="thumb" alt="" style="display:none">
              <div class="btns" style="margin-top:6px">
                <button class="btn secondary" id="btn-clear-img">ç§»é™¤åœ–ç‰‡</button>
              </div>
            </div>
          </div>
          <div>
            <label>å‚™è¨»ï¼è§£é¡Œé—œéµï¼ˆé¸å¡«ï¼‰</label>
            <textarea id="f-notes" placeholder="çµ¦å­©å­çš„æé†’æˆ–èª¤å€"></textarea>
          </div>
          <div class="row">
            <div>
              <label>æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label>
              <input id="f-tags" type="text" placeholder="ä¾‹ï¼šåˆ†æ•¸, é€šåˆ†, ç´„åˆ†">
            </div>
            <div class="btns" style="align-items:end">
              <button class="btn" id="btn-save">æ–°å¢åˆ°é¡Œåº«</button>
              <button class="btn secondary" id="btn-clear">æ¸…ç©ºæ¬„ä½</button>
            </div>
          </div>
        </div>
        <div>
          <div class="card">
            <h3>å³æ™‚é è¦½</h3>
            <div>
              <span class="pill" id="prev-subject">â€”</span>
              <span class="pill" id="prev-grade">â€”å¹´ç´š</span>
              <span class="pill" id="prev-tags">â€”</span>
            </div>
            <h3 id="prev-title" style="margin-top:10px">ï¼ˆçŸ­æ¨™é¡Œï¼‰</h3>
            <p class="q" id="prev-q">ï¼ˆé¡Œç›®æœƒé¡¯ç¤ºåœ¨é€™è£¡ï¼‰</p>
            <img id="prev-img" class="thumb" alt="" style="display:none">
            <p class="a" id="prev-a">ï¼ˆè§£ç­”ï¼‰</p>
          </div>
        </div>
      </div>
    </section>

    <!-- é¡Œåº«åˆ—è¡¨ -->
    <section id="tab-list" class="panel" hidden>
      <div class="toolbar" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
        <div>
          <label>é—œéµå­—æœå°‹</label><br>
          <input id="q" type="text" placeholder="è¼¸å…¥ ID / æ¨™é¡Œ / é¡Œç›® / è§£ç­” / æ¨™ç±¤â€¦" style="width:360px;padding:8px 10px;border:1px solid var(--bor);border-radius:10px">
        </div>
        <div>
          <label>ç§‘ç›®</label><br>
          <select id="flt-subject">
            <option value="">å…¨éƒ¨</option>
            <option>åœ‹æ–‡</option><option>è‹±æ–‡</option><option>æ•¸å­¸</option><option>è‡ªç„¶</option><option>ç¤¾æœƒ</option>
          </select>
        </div>
        <div>
          <label>å¹´ç´šï¼ˆæœ€å°ï¼‰</label><br>
          <input id="flt-grade" type="number" min="1" max="9" placeholder="1~9" style="width:120px">
        </div>
        <div>
          <label>é¡åˆ¥ï¼ˆçœ‹ç›®å‰ä½¿ç”¨è€…çš„æ¨™è¨˜ï¼‰</label><br>
          <select id="flt-cat">
            <option value="">å…¨éƒ¨</option>
            <option value="important">é‡è¦é¡Œç›®</option>
            <option value="wrong">éŒ¯é¡Œæ›´æ­£</option>
            <option value="special">ç‰¹æ®Šé¡Œç›®</option>
          </select>
        </div>
        <div class="right btns" style="margin-left:auto">
          <button class="btn secondary" id="btn-export-backup">åŒ¯å‡ºå‚™ä»½ JSONï¼ˆå«æ‰€æœ‰ä½¿ç”¨è€…ï¼‰</button>
          <label class="btn secondary" for="impFile" style="cursor:pointer">åŒ¯å…¥å‚™ä»½ JSON</label>
          <input id="impFile" type="file" accept="application/json" style="display:none">
          <button class="btn secondary" id="btn-backup-now">ä¸€éµå‚™ä»½</button>
          <label class="btn secondary" style="cursor:pointer">
            <input type="checkbox" id="autoBackupToggle" style="margin-right:6px">
            è‡ªå‹•å‚™ä»½ï¼ˆä¸‹è¼‰ JSONï¼‰
          </label>
        </div>
      </div>

      <div style="overflow:auto;max-height:60vh">
        <table id="tbl">
          <thead>
            <tr>
              <th style="width:120px">ID</th>
              <th style="width:150px">ç§‘ç›®ï¼å¹´ç´š</th>
              <th style="width:220px">çŸ­æ¨™é¡Œ</th>
              <th>é¡Œç›®ï¼ˆç›´æ¥é¡¯ç¤ºï¼‰</th>
              <th style="width:130px">åœ–ç‰‡</th>
              <th style="width:150px">æˆ‘çš„æ¨™è¨˜</th>
              <th style="width:200px">æˆ‘çš„ SRS ä¸‹ä¸€æ¬¡</th>
              <th style="width:240px">æ“ä½œï¼ˆåªå½±éŸ¿æˆ‘ï¼‰</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- åˆ·é¡Œæ¨¡å¼ -->
    <section id="tab-practice" class="panel" hidden>
      <div class="toolbar" style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
        <div>
          <label>ç§‘ç›®</label><br>
          <select id="pr-subject">
            <option value="">å…¨éƒ¨</option>
            <option>åœ‹æ–‡</option><option>è‹±æ–‡</option><option>æ•¸å­¸</option><option>è‡ªç„¶</option><option>ç¤¾æœƒ</option>
          </select>
        </div>
        <div>
          <label>å¹´ç´šï¼ˆæœ€å°ï¼‰</label><br>
          <input id="pr-grade" type="number" min="1" max="9" placeholder="1~9" style="width:120px">
        </div>
        <div>
          <label>é¡Œæ•¸</label><br>
          <input id="pr-n" type="number" min="1" value="5" style="width:120px">
        </div>
        <div>
          <label>é¡Œåº«ä¾†æºï¼ˆçœ‹ç›®å‰ä½¿ç”¨è€…çš„æ¨™è¨˜ï¼‰</label><br>
          <select id="pr-cat">
            <option value="">å…¨éƒ¨</option>
            <option value="important">åªåˆ·ï¼šé‡è¦é¡Œç›®</option>
            <option value="wrong">åªåˆ·ï¼šéŒ¯é¡Œæ›´æ­£</option>
            <option value="special">åªåˆ·ï¼šç‰¹æ®Šé¡Œç›®</option>
          </select>
        </div>
        <label><input type="checkbox" id="pr-due-only"> åªç·´ã€Œåˆ°æœŸï¼é€¾æœŸã€é¡Œç›®ï¼ˆSRSï¼‰</label>
        <div class="btns" style="margin-left:auto">
          <button class="btn" id="pr-start">é–‹å§‹åˆ·é¡Œ</button>
          <button class="btn secondary" id="pr-reset">é‡è¨­</button>
        </div>
      </div>

      <div id="pr-area" style="display:none">
        <div class="card">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <span class="pill" id="pr-meta">â€”</span>
            <span class="pill" id="pr-srs">SRSï¼šâ€”</span>
          </div>
          <h3 id="pr-title">ï¼ˆçŸ­æ¨™é¡Œï¼‰</h3>
          <div class="q" id="pr-q">ï¼ˆé¡Œç›®æœƒé¡¯ç¤ºåœ¨é€™è£¡ï¼‰</div>
          <img id="pr-img" class="thumb" alt="" style="display:none">
          <div class="a" id="pr-a">ï¼ˆè§£ç­”ï¼‰</div>
          <div class="btns" style="margin-top:10px">
            <button class="btn secondary" id="btn-toggle-answer">é¡¯ç¤ºï¼éš±è—è§£ç­”</button>
            <button class="btn success" id="btn-easy">å¾ˆç†Ÿ ğŸ˜„ï¼ˆ+7å¤©ï¼‰</button>
            <button class="btn" id="btn-good">æœƒäº† ğŸ™‚ï¼ˆ+3å¤©ï¼‰</button>
            <button class="btn warn" id="btn-again">å†çœ‹ ğŸ˜µï¼ˆ+1å¤©ï¼‰</button>
            <button class="btn secondary" id="btn-next">ä¸‹ä¸€é¡Œ â–¶</button>
          </div>
          <div class="progress" style="margin-top:8px"><div id="pr-bar" style="width:0%"></div></div>
        </div>
        <p class="mut" id="pr-progress">é€²åº¦ï¼š0 / 0</p>
      </div>
    </section>

    <!-- çµ±è¨ˆ -->
    <section id="tab-stats" class="panel" hidden>
      <div class="grid">
        <div class="card">
          <h3>é¡Œåº«æ¦‚æ³ï¼ˆå…¨é«”ï¼‰</h3>
          <div id="st-overview">â€”</div>
        </div>
        <div class="card">
          <h3>æˆ‘çš„å­¸ç¿’çµ±è¨ˆï¼ˆä¾ç›®å‰ä½¿ç”¨è€…ï¼‰</h3>
          <div id="st-user">â€”</div>
        </div>
        <div class="card">
          <h3>åˆ†å¹´ç´šçµ±è¨ˆï¼ˆé¡Œæ•¸ï¼åˆ°æœŸï¼‰</h3>
          <div id="st-grade">â€”</div>
        </div>
      </div>
    </section>
  </div>

  <audio id="snd-pass"></audio>
  <audio id="snd-pop"></audio>

<script>
/************** å¸¸æ•¸ / å·¥å…· **************/
const ITEMS_KEY = 'v12_items';
const USERS_KEY = 'v12_users';
const BANK_KEY = 'v12_bankname';
const CUR_USER_KEY = 'v12_current_user';
const AUTO_BACKUP_KEY = 'v12_auto_backup';
const AUTO_BACKUP_LAST = 'v12_auto_backup_last';

function $(sel){ return document.querySelector(sel); }
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function toast(msg, kind='info'){
  const t = document.createElement('div'); t.className='toast'; t.textContent=msg; if(kind==='error'){ t.style.background='#b91c1c'; }
  document.body.appendChild(t); setTimeout(()=>t.remove(), 1800);
}
function download(filename, content, mime){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([content], {type:mime||'text/plain'})); a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 500); }
function shuffle(arr){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function now(){ return Date.now(); }
function nowStr(){ const d=new Date(),p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`; }
function fmtDate(ts){ if(!ts) return 'â€”'; const d=new Date(ts); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`; }

// æ¯äººç‹€æ…‹å–®ç¨å„²å­˜åœ¨ userStateKey(userId)
function userStateKey(uid){ return `v12_userstate_${uid}`; }
function loadUserState(uid){ try{ const s=localStorage.getItem(userStateKey(uid)); return s? JSON.parse(s): {}; }catch{ return {}; } }
function saveUserState(uid, state){ localStorage.setItem(userStateKey(uid), JSON.stringify(state)); }

// simple sounds
function playTone(type='pass'){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator(); const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination); o.type='sine';
    if(type==='pass'){ o.frequency.value=880; g.gain.setValueAtTime(0.0001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.02); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.3); }
    if(type==='pop'){ o.frequency.value=520; g.gain.setValueAtTime(0.0001, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.25, ctx.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.12); }
    o.start(); o.stop(ctx.currentTime + (type==='pass'?0.32:0.14));
  }catch{}
}

// confetti
const c = document.getElementById('confetti'); const cx = c.getContext('2d');
let confetti = [];
function fireConfetti(){
  const W = c.width = window.innerWidth; const H = window.innerHeight; c.height = H;
  const colors = ['#a78bfa','#60a5fa','#34d399','#fbbf24','#f472b6'];
  for(let i=0;i<80;i++){
    confetti.push({x:Math.random()*W,y:-10-Math.random()*H,vx:(Math.random()-0.5)*2,vy:2+Math.random()*3,size:4+Math.random()*4,color:colors[(Math.random()*colors.length)|0],life:80+Math.random()*40});
  }
  (function anim(){
    cx.clearRect(0,0,W,H);
    confetti.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=0.02; p.life--; cx.fillStyle=p.color; cx.fillRect(p.x,p.y,p.size,p.size); });
    confetti = confetti.filter(p=> p.y<H && p.life>0);
    if(confetti.length) requestAnimationFrame(anim);
  })();
}

/************** è³‡æ–™è¼‰å…¥ **************/
function loadItems(){ try{ const s=localStorage.getItem(ITEMS_KEY); return s? JSON.parse(s): []; }catch{ return []; } }
function saveItems(items){ localStorage.setItem(ITEMS_KEY, JSON.stringify(items)); stat(); maybeAutoBackup(); }

function loadUsers(){ try{ const s=localStorage.getItem(USERS_KEY); return s? JSON.parse(s): []; }catch{ return []; } }
function saveUsers(users){ localStorage.setItem(USERS_KEY, JSON.stringify(users)); }

function loadBank(){ return localStorage.getItem(BANK_KEY) || 'åˆ·é¡Œè¤‡ç¿’é¡Œåº«'; }
function saveBank(name){ localStorage.setItem(BANK_KEY, name); }

function loadCurUserId(){ return localStorage.getItem(CUR_USER_KEY) || ''; }
function saveCurUserId(uid){ localStorage.setItem(CUR_USER_KEY, uid); }

let ITEMS = loadItems();
let USERS = loadUsers();
if(USERS.length===0){ USERS=[{id:'u1', name:'å­¸ç”Ÿ1', grade:1}]; saveUsers(USERS); }
let CUR_UID = loadCurUserId() || USERS[0].id;
saveCurUserId(CUR_UID);

/************** Header / ä½¿ç”¨è€…åˆ‡æ› **************/
const bankTitle = $('#bank-title'), bankName = $('#bank-name'), userSelect = $('#user-select'), curUserPill=$('#cur-user-pill');
function refreshHeader(){
  const bank = loadBank(); bankTitle.textContent = bank; bankName.value = bank;
  userSelect.innerHTML = USERS.map(u=> `<option value="${u.id}">${esc(u.name)}ï¼ˆ${u.grade}å¹´ç´šï¼‰</option>`).join('');
  userSelect.value = CUR_UID;
  const u = USERS.find(x=>x.id===CUR_UID);
  curUserPill.textContent = u? `ä½¿ç”¨è€…ï¼š${u.name}ï½œ${u.grade}å¹´ç´š` : 'â€”';
}
refreshHeader();

$('#bank-name').addEventListener('change', ()=>{ saveBank($('#bank-name').value.trim()||'åˆ·é¡Œè¤‡ç¿’é¡Œåº«'); refreshHeader(); });

userSelect.addEventListener('change', ()=>{
  CUR_UID = userSelect.value;
  saveCurUserId(CUR_UID);
  refreshHeader();
  renderTable(); stat(); // é‡æ–°å¥—ç”¨ã€Œæˆ‘çš„æ¨™è¨˜ã€è¦–åœ–
});

$('#btn-user-add').addEventListener('click', ()=>{
  const name = prompt('è¼¸å…¥æ–°ä½¿ç”¨è€…å§“å'); if(!name) return;
  let grade = parseInt(prompt('è¼¸å…¥å¹´ç´šï¼ˆ1~9ï¼‰')||'1',10); if(isNaN(grade)) grade=1; grade=Math.min(9,Math.max(1,grade));
  const id = 'u'+Math.random().toString(36).slice(2,8);
  USERS.push({id,name,grade}); saveUsers(USERS);
  saveUserState(id, {}); // å»ºç«‹ç©ºç‹€æ…‹
  CUR_UID = id; saveCurUserId(id);
  refreshHeader(); renderTable(); stat(); toast('å·²æ–°å¢ä½¿ç”¨è€…');
});

$('#btn-user-edit').addEventListener('click', ()=>{
  const u = USERS.find(x=>x.id===CUR_UID); if(!u) return;
  const name = prompt('ä¿®æ”¹å§“å', u.name)||u.name;
  let grade = parseInt(prompt('ä¿®æ”¹å¹´ç´šï¼ˆ1~9ï¼‰', String(u.grade))||String(u.grade),10); if(isNaN(grade)) grade=u.grade; grade=Math.min(9,Math.max(1,grade));
  u.name=name; u.grade=grade; saveUsers(USERS);
  refreshHeader(); stat(); toast('å·²æ›´æ–°ä½¿ç”¨è€…è³‡æ–™');
});

$('#btn-user-del').addEventListener('click', ()=>{
  if(!confirm('ç¢ºå®šåˆªé™¤ç›®å‰ä½¿ç”¨è€…ï¼Ÿï¼ˆåƒ…åˆªé™¤è©²ä½¿ç”¨è€…çš„å­¸ç¿’ç´€éŒ„ï¼Œä¸æœƒåˆªé¡Œç›®ï¼‰')) return;
  const idx = USERS.findIndex(x=>x.id===CUR_UID); if(idx<0) return;
  // åˆªé™¤å…¶ userState
  localStorage.removeItem(userStateKey(CUR_UID));
  USERS.splice(idx,1); if(USERS.length===0){ USERS=[{id:'u1',name:'å­¸ç”Ÿ1',grade:1}]; }
  saveUsers(USERS);
  CUR_UID = USERS[0].id; saveCurUserId(CUR_UID);
  refreshHeader(); renderTable(); stat(); toast('å·²åˆªé™¤ä½¿ç”¨è€…');
});

/************** æ–°å¢é¡Œç›®ï¼ˆå«åœ–ç‰‡è™•ç†ï¼‰ **************/
const f = {
  id: $('#f-id'), subject: $('#f-subject'), grade: $('#f-grade'), title: $('#f-title'),
  q: $('#f-q'), a: $('#f-a'), notes: $('#f-notes'), tags: $('#f-tags'),
  img: $('#f-img')
};
const prev = { subject:$('#prev-subject'), grade:$('#prev-grade'), tags:$('#prev-tags'), title:$('#prev-title'), q:$('#prev-q'), a:$('#prev-a'), img:$('#prev-img') };
const imgPreview = $('#img-preview');
let currentImgData = '';

['input','change','keyup'].forEach(ev=>{ [f.subject,f.grade,f.title,f.q,f.a,f.tags].forEach(el=> el.addEventListener(ev, updatePreview)); });
function updatePreview(){
  prev.subject.textContent = f.subject.value||'â€”';
  prev.grade.textContent = `${f.grade.value||'â€”'}å¹´ç´š`;
  prev.tags.textContent = (f.tags.value||'â€”');
  prev.title.textContent = f.title.value||'ï¼ˆçŸ­æ¨™é¡Œï¼‰';
  prev.q.textContent = f.q.value||'ï¼ˆé¡Œç›®æœƒé¡¯ç¤ºåœ¨é€™è£¡ï¼‰';
  prev.a.textContent = f.a.value||'ï¼ˆè§£ç­”ï¼‰'; prev.a.style.display = f.a.value.trim()? 'block':'none';
  if(currentImgData){ prev.img.src=currentImgData; prev.img.style.display='block'; } else { prev.img.style.display='none'; }
}
updatePreview();

function fileToDataURL(file, cb){
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      const max = 1200;
      let w = img.width, h = img.height;
      if(w>h && w>max){ h = Math.round(h*max/w); w = max; }
      else if(h>=w && h>max){ w = Math.round(w*max/h); h = max; }
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      const data = canvas.toDataURL('image/jpeg', 0.8);
      cb(data);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}
f.img.addEventListener('change', ()=>{
  const file = f.img.files[0]; if(!file){ currentImgData=''; imgPreview.style.display='none'; updatePreview(); return; }
  fileToDataURL(file, (data)=>{ currentImgData=data; imgPreview.src=data; imgPreview.style.display='block'; updatePreview(); });
});
$('#btn-clear-img').addEventListener('click', ()=>{ currentImgData=''; f.img.value=''; imgPreview.style.display='none'; updatePreview(); });

function genId(){
  const sub = { 'åœ‹æ–‡':'CH', 'è‹±æ–‡':'EN', 'æ•¸å­¸':'MA', 'è‡ªç„¶':'SC', 'ç¤¾æœƒ':'SS' }[f.subject.value] || 'OT';
  let max = 0;
  ITEMS.forEach(x=>{ const m=(x.id||'').match(new RegExp(`^BK-${sub}-(\\d+)$`)); if(m){ const n=parseInt(m[1],10); if(n>max) max=n; } });
  return `BK-${sub}-${String(max+1).padStart(3,'0')}`;
}

function clearForm(){ Object.values(f).forEach(el=>{ if(el.type==='checkbox') el.checked=false; else el.value=''; }); f.grade.value='1'; f.subject.value='æ•¸å­¸'; currentImgData=''; imgPreview.style.display='none'; updatePreview(); }

$('#btn-save').addEventListener('click', ()=>{
  const title = f.title.value.trim(), q = f.q.value.trim();
  if(!title || !q){ toast('è«‹å¡«ã€ŒçŸ­æ¨™é¡Œã€èˆ‡ã€Œé¡Œç›®ã€','error'); return; }
  const obj = {
    id: (f.id.value.trim() || genId()),
    subject: f.subject.value, grade: Math.min(9, Math.max(1, parseInt(f.grade.value||'1',10))),
    title, q, a: f.a.value.trim(), notes: f.notes.value.trim(),
    tags: (f.tags.value? f.tags.value.split(',').map(s=>s.trim()).filter(Boolean):[]),
    img: currentImgData || '',
    created_at: nowStr(), updated_at: nowStr()
  };
  const i = ITEMS.findIndex(x=> x && x.id===obj.id);
  if(i>=0){ obj.created_at = ITEMS[i].created_at || obj.created_at; ITEMS[i]=obj; }
  else ITEMS.push(obj);
  saveItems(ITEMS);
  playTone('pop'); toast(i>=0? 'å·²æ›´æ–°é¡Œç›®' : 'å·²æ–°å¢é¡Œç›®'); clearForm(); renderTable();
});
$('#btn-clear').addEventListener('click', clearForm);

/************** åˆ—è¡¨ï¼ˆæ¯äººæ¨™è¨˜ / SRSï¼‰ **************/
const tbody = document.querySelector('#tbl tbody');
const inpQ = $('#q'), fltSub = $('#flt-subject'), fltGrade = $('#flt-grade'), fltCat = $('#flt-cat');
function getMyState(){ return loadUserState(CUR_UID); }
function ensureQState(st, id){ if(!st[id]) st[id]={ stats:{seen:0,correct:0,wrong:0,last:''}, srs:{next_due:0,interval:0}, flags:{wrong:false,important:false,special:false} }; return st[id]; }

function renderTable(){
  const st = getMyState();
  const kw = (inpQ.value||'').trim().toLowerCase();
  const sub = fltSub.value||''; const g = parseInt(fltGrade.value||'0',10); const cat = fltCat.value||'';
  let rows = ITEMS.filter(Boolean);
  if(kw){ rows = rows.filter(x=> [x.id,x.title,x.q,x.a,(x.tags||[]).join(',')].join(' ').toLowerCase().includes(kw)); }
  if(sub){ rows = rows.filter(x=> x.subject===sub); }
  if(g){ rows = rows.filter(x=> x.grade>=g); }
  if(cat){ rows = rows.filter(x=> ensureQState(st,x.id).flags[cat]===true); }
  rows.sort((a,b)=> a.subject.localeCompare(b.subject) || a.grade-b.grade || (a.id||'').localeCompare(b.id||''));

  tbody.innerHTML = rows.map(x=>{
    const s = ensureQState(st,x.id);
    const cats = [s.flags.important?'é‡è¦':'' , s.flags.wrong?'éŒ¯é¡Œ':'' , s.flags.special?'ç‰¹æ®Š':''].filter(Boolean).join('ã€') || 'â€”';
    const due = s.srs?.next_due ? fmtDate(s.srs.next_due) : 'â€”';
    const img = x.img? `<img src="${x.img}" alt="" />`:'â€”';
    return `<tr>
      <td>${esc(x.id)}</td>
      <td>${esc(x.subject)}ï¼${esc(x.grade)}å¹´ç´š</td>
      <td>${esc(x.title)}</td>
      <td><div style="white-space:pre-wrap">${esc(x.q)}</div></td>
      <td class="imgcell">${img}</td>
      <td>${esc(cats)}</td>
      <td>${esc(due)}</td>
      <td>
        <button class="btn secondary" data-act="edit" data-id="${esc(x.id)}">ç·¨è¼¯é¡Œç›®ï¼ˆå…±ç”¨ï¼‰</button>
        <button class="btn secondary" data-act="flag-important" data-id="${esc(x.id)}">åˆ‡æ›é‡è¦</button>
        <button class="btn secondary" data-act="flag-wrong" data-id="${esc(x.id)}">åˆ‡æ›éŒ¯é¡Œ</button>
        <button class="btn secondary" data-act="flag-special" data-id="${esc(x.id)}">åˆ‡æ›ç‰¹æ®Š</button>
        <button class="btn warn" data-act="del" data-id="${esc(x.id)}">åˆªé™¤é¡Œç›®ï¼ˆå…±ç”¨ï¼‰</button>
      </td>
    </tr>`;
  }).join('');
  stat();
}

[ inpQ, fltSub, fltGrade, fltCat ].forEach(el=> el.addEventListener('input', renderTable));

tbody.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-act]'); if(!btn) return;
  const id = btn.getAttribute('data-id'); const act = btn.getAttribute('data-act');
  const item = ITEMS.find(x=> x && x.id===id); if(!item){ toast('æ‰¾ä¸åˆ°é¡Œç›®','error'); return; }
  if(act==='edit'){
    // è¼‰å…¥åˆ°æ–°å¢å€ï¼ˆç·¨è¼¯å…±ç”¨å…§å®¹ï¼‰
    showTab('add');
    f.id.value=item.id; f.subject.value=item.subject; f.grade.value=item.grade; f.title.value=item.title;
    f.q.value=item.q; f.a.value=item.a||''; f.notes.value=item.notes||''; f.tags.value=(item.tags||[]).join(', ');
    currentImgData = item.img||''; if(currentImgData){ imgPreview.src=currentImgData; imgPreview.style.display='block'; } else imgPreview.style.display='none';
    updatePreview(); toast('å·²è¼‰å…¥è‡³ç·¨è¼¯å€');
  }else if(act==='del'){
    if(!confirm('åˆªé™¤å¾Œæ‰€æœ‰ä½¿ç”¨è€…éƒ½çœ‹ä¸åˆ°æ­¤é¡Œç›®ï¼Œç¢ºå®šï¼Ÿ')) return;
    ITEMS = ITEMS.filter(x=> x && x.id!==id); saveItems(ITEMS); renderTable(); toast('å·²åˆªé™¤é¡Œç›®');
  }else if(act.startsWith('flag-')){
    const st = getMyState(); const qs = ensureQState(st, id);
    const key = act.replace('flag-','');
    qs.flags[key] = !qs.flags[key];
    saveUserState(CUR_UID, st); maybeAutoBackup();
    renderTable();
  }
});

/************** åŒ¯å‡ºï¼åŒ¯å…¥ï¼å‚™ä»½ **************/
function exportBackup(){
  const bundle = {
    bank: loadBank(),
    items: ITEMS,
    users: USERS,
    states: {}
  };
  USERS.forEach(u=>{ bundle.states[u.id] = loadUserState(u.id); });
  const ts = new Date(); const p=n=>String(n).padStart(2,'0');
  const name = `drill_v12_backup_${ts.getFullYear()}${p(ts.getMonth()+1)}${p(ts.getDate())}-${p(ts.getHours())}${p(ts.getMinutes())}${p(ts.getSeconds())}.json`;
  download(name, JSON.stringify(bundle, null, 2), 'application/json;charset=utf-8');
}
$('#btn-export-backup').addEventListener('click', exportBackup);

$('#impFile').addEventListener('change', (ev)=>{
  const file=ev.target.files[0]; if(!file) return; const fr=new FileReader();
  fr.onload=()=>{ try{
      const obj=JSON.parse(fr.result);
      if(!obj || !Array.isArray(obj.items) || !Array.isArray(obj.users)) throw new Error('æ ¼å¼ä¸æ­£ç¢ºï¼ˆç¼º items æˆ– usersï¼‰');
      ITEMS = obj.items; saveItems(ITEMS);
      USERS = obj.users; saveUsers(USERS);
      if(obj.bank) saveBank(obj.bank);
      // states
      if(obj.states && typeof obj.states==='object'){
        Object.keys(obj.states).forEach(uid=> localStorage.setItem(userStateKey(uid), JSON.stringify(obj.states[uid])) );
      }
      CUR_UID = USERS[0]?.id || 'u1'; saveCurUserId(CUR_UID);
      refreshHeader(); renderTable(); stat(); toast('å·²åŒ¯å…¥å‚™ä»½');
      ev.target.value='';
    }catch(err){ alert('åŒ¯å…¥å¤±æ•—ï¼š'+err.message); }
  };
  fr.readAsText(file, 'utf-8');
});

function isAutoBackupOn(){ return localStorage.getItem(AUTO_BACKUP_KEY) === '1'; }
function setAutoBackup(on){ localStorage.setItem(AUTO_BACKUP_KEY, on ? '1' : '0'); }
function maybeAutoBackup(){
  const t = $('#autoBackupToggle'); if(!t) return;
  if(!isAutoBackupOn()) return;
  const nowt = now();
  const last = parseInt(localStorage.getItem(AUTO_BACKUP_LAST)||'0',10);
  if(isNaN(last) || nowt - last > 60*1000){
    exportBackup();
    localStorage.setItem(AUTO_BACKUP_LAST, String(nowt));
  }
}
const autoToggle = $('#autoBackupToggle');
if(autoToggle){
  autoToggle.checked = isAutoBackupOn();
  autoToggle.addEventListener('change', ()=>{ setAutoBackup(autoToggle.checked); toast(autoToggle.checked?'å·²é–‹å•Ÿè‡ªå‹•å‚™ä»½':'å·²é—œé–‰è‡ªå‹•å‚™ä»½'); });
}
$('#btn-backup-now').addEventListener('click', ()=>{ exportBackup(); toast('å·²ä¸‹è¼‰å‚™ä»½ JSON'); });

/************** åˆ·é¡Œæ¨¡å¼ï¼ˆä»¥ç›®å‰ä½¿ç”¨è€…çš„ç‹€æ…‹ç‚ºæº–ï¼‰ **************/
let PR_QUEUE = [], PR_IDX = -1;
function resetPracticeUI(){ $('#pr-area').style.display='none'; $('#pr-progress').textContent='é€²åº¦ï¼š0 / 0'; $('#pr-bar').style.width='0%'; }
function buildPracticePool(){
  const st = getMyState();
  const sub = $('#pr-subject').value||''; const g = parseInt($('#pr-grade').value||'0',10); const cat = $('#pr-cat').value||''; const dueOnly = $('#pr-due-only').checked;
  let rows = ITEMS.filter(Boolean);
  if(sub) rows = rows.filter(x=> x.subject===sub);
  if(g) rows = rows.filter(x=> x.grade>=g);
  if(cat) rows = rows.filter(x=> ensureQState(st,x.id).flags[cat]===true);
  if(dueOnly){ const t=now(); rows = rows.filter(x=> (ensureQState(st,x.id).srs.next_due||0) <= t); }
  rows.sort((a,b)=> (ensureQState(st,a.id).srs.next_due||0) - (ensureQState(st,b.id).srs.next_due||0));
  return rows;
}
function startPractice(){
  const n = Math.max(1, parseInt($('#pr-n').value||'5',10));
  let pool = buildPracticePool();
  if(pool.length===0){ toast('ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é¡Œç›®','error'); return; }
  PR_QUEUE = shuffle(pool).slice(0, Math.min(n, pool.length));
  PR_IDX = 0; $('#pr-area').style.display='block'; renderPractice();
}
function renderPractice(){
  const st = getMyState();
  if(PR_IDX<0 || PR_IDX>=PR_QUEUE.length){ resetPracticeUI(); toast('æœ¬å›åˆå®Œæˆ'); fireConfetti(); playTone('pass'); return; }
  const q = PR_QUEUE[PR_IDX]; const s = ensureQState(st,q.id);
  $('#pr-meta').textContent = `${q.id}ï½œ${q.subject}ï¼${q.grade}å¹´ç´š`;
  $('#pr-title').textContent = q.title;
  $('#pr-q').textContent = q.q;
  const imgEl = $('#pr-img'); if(q.img){ imgEl.src=q.img; imgEl.style.display='block'; } else { imgEl.style.display='none'; }
  const ans = $('#pr-a'); ans.textContent = q.a || 'ï¼ˆè§£ç­”æœªå¡«ï¼‰'; ans.style.display='none';
  $('#pr-srs').textContent = `ä¸‹æ¬¡ï¼š${fmtDate(s.srs?.next_due)}ï¼ˆé–“éš” ${s.srs?.interval||0}å¤©ï¼‰`;
  $('#pr-progress').textContent = `é€²åº¦ï¼š${PR_IDX+1} / ${PR_QUEUE.length}`;
  $('#pr-bar').style.width = `${Math.round((PR_IDX)/PR_QUEUE.length*100)}%`;
}
$('#pr-start').addEventListener('click', startPractice);
$('#pr-reset').addEventListener('click', resetPracticeUI);
$('#btn-toggle-answer').addEventListener('click', ()=>{
  const ans = $('#pr-a'); ans.style.display = (ans.style.display==='none')? 'block':'none';
});

function srsUpdate(qid, addDays, correct){
  const st = getMyState();
  const s = ensureQState(st,qid);
  const dayMs = 24*60*60*1000;
  const base = Math.max(now(), s.srs?.next_due||now());
  const next = base + addDays*dayMs;
  s.srs = { next_due: next, interval: addDays };
  s.stats = s.stats||{seen:0,correct:0,wrong:0,last:''};
  s.stats.seen++; if(correct) s.stats.correct++; else s.stats.wrong++; s.stats.last = nowStr();
  saveUserState(CUR_UID, st); maybeAutoBackup();
}
$('#btn-easy').addEventListener('click', ()=>{ const q=PR_QUEUE[PR_IDX]; if(!q) return; srsUpdate(q.id,7,true); playTone('pass'); PR_IDX++; renderPractice(); });
$('#btn-good').addEventListener('click', ()=>{ const q=PR_QUEUE[PR_IDX]; if(!q) return; srsUpdate(q.id,3,true); playTone('pop'); PR_IDX++; renderPractice(); });
$('#btn-again').addEventListener('click', ()=>{ const q=PR_QUEUE[PR_IDX]; if(!q) return; srsUpdate(q.id,1,false); PR_IDX++; renderPractice(); });
$('#btn-next').addEventListener('click', ()=>{ PR_IDX++; renderPractice(); });

/************** çµ±è¨ˆ **************/
function stat(){
  const u = USERS.find(x=>x.id===CUR_UID);
  $('#stat').textContent = `é¡Œæ•¸ï¼š${ITEMS.length}ï½œç›®å‰ä½¿ç”¨è€…ï¼š${u?`${u.name}/${u.grade}å¹´ç´š`:'â€”'}ï½œé¡Œåº«ï¼š${loadBank()}`;
}

function renderStats(){
  // å…¨é«”é¡Œåº«æ¦‚æ³
  const bySub = {}; const byGrade = {};
  ITEMS.forEach(x=>{
    bySub[x.subject] = (bySub[x.subject]||0)+1;
    byGrade[x.grade] = (byGrade[x.grade]||0)+1;
  });
  const subjects = ['åœ‹æ–‡','è‹±æ–‡','æ•¸å­¸','è‡ªç„¶','ç¤¾æœƒ'];
  $('#st-overview').innerHTML = `
    <div>ç¸½é¡Œæ•¸ï¼š<b>${ITEMS.length}</b></div>
    <div>${subjects.map(sub=>`${sub}ï¼š<b>${bySub[sub]||0}</b>`).join('ã€€')}</div>
  `;

  // ç›®å‰ä½¿ç”¨è€…çµ±è¨ˆ
  const st = getMyState();
  let seen=0,correct=0,wrong=0, due=0, flags={important:0,wrong:0,special:0};
  ITEMS.forEach(x=>{
    const s = ensureQState(st,x.id);
    seen+=s.stats.seen||0; correct+=s.stats.correct||0; wrong+=s.stats.wrong||0;
    if((s.srs.next_due||0)<=now()) due++;
    if(s.flags.important) flags.important++;
    if(s.flags.wrong) flags.wrong++;
    if(s.flags.special) flags.special++;
  });
  $('#st-user').innerHTML = `
    <div>ä½œç­”æ¬¡æ•¸ï¼š${seen}ï¼ˆæ­£ç¢º ${correct}ï¼éŒ¯èª¤ ${wrong}ï¼‰</div>
    <div>æˆ‘çš„æ¨™è¨˜ï¼šé‡è¦ ${flags.important}ï½œéŒ¯é¡Œ ${flags.wrong}ï½œç‰¹æ®Š ${flags.special}ï½œåˆ°æœŸ/é€¾æœŸ ${due}</div>
  `;

  // åˆ†å¹´ç´šçµ±è¨ˆï¼ˆé¡Œæ•¸èˆ‡åˆ°æœŸï¼‰
  let html = `<table style="width:100%;border-collapse:collapse"><thead><tr><th>å¹´ç´š</th><th>é¡Œæ•¸</th><th>åˆ°æœŸ/é€¾æœŸï¼ˆä»¥æˆ‘ï¼‰</th></tr></thead><tbody>`;
  for(let g=1; g<=9; g++){
    const n = byGrade[g]||0;
    let dueG=0;
    ITEMS.forEach(x=>{ if(x.grade>=g){ const s=ensureQState(st,x.id); if((s.srs.next_due||0)<=now()) dueG++; } });
    html += `<tr><td>${g}</td><td>${n}</td><td>${dueG}</td></tr>`;
  }
  html += `</tbody></table>`;
  $('#st-grade').innerHTML = html;
}

// åˆå§‹æ¸²æŸ“
renderTable(); stat(); renderStats();

/************** åˆ†é åˆ‡æ› **************/
const tabs = document.querySelectorAll('.tabBtn');
function showTab(id){
  tabs.forEach(b=> b.classList.toggle('active', b.dataset.tab===id));
  ['add','list','practice','stats'].forEach(t=> $('#tab-'+t).hidden = (t!==id));
  if(id==='list') renderTable();
  if(id==='practice') resetPracticeUI();
  if(id==='stats') renderStats();
}
tabs.forEach(b=> b.addEventListener('click', ()=> showTab(b.dataset.tab)) );
</script>
</body>
</html>
